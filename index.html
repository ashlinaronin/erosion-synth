<html>
  <head>
    <title>erosion-synth</title>
  </head>
  <body>
    <div id="instrument">
      <button type="button" id="play-stop">play/stop</button>
    </div>

    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.68/Tone.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/startaudiocontext@1.2.1/StartAudioContext.min.js"
    ></script>
    <!-- <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/nexusui@2.1.5/dist/NexusUI.min.js"
    ></script> -->
    <!-- <script type="module">
      // const createUi = () => {
      //   const dial = Nexus.Add.Dial("#instrument", { size: [100, 100] });
      //   const slider = Nexus.Add.Slider("#instrument", { size: [25, 100] });
      //   const position = Nexus.Add.Position("#instrument", {
      //     size: [200, 200],
      //   });

      //   dial.on("change", (v) => console.log(v));
      //   slider.on("change", (v) => console.log(v));
      // };
      // createUi();
    </script> -->
    <script type="module">
      let playing = true;

      const play = async () => {
        const bell = new Tone.MetalSynth({
          harmonicity: 3,
          // frequency: 400,
          resonance: 230,
          detune: 70,
          modulationIndex: 12,
          envelope: {
            attack: 0.003,
            decay: 0.3,
            release: 0.5,
          },
          volume: -15,
        }).toDestination();
        const pitchEnvelope = new Tone.FrequencyEnvelope({
          attack: 0.05,
          decay: 0.3,
          baseFrequency: 0.1,
          octaves: 1,
        });

        [0, 1, 2, 3, 4, 5].forEach((num) => {
          pitchEnvelope.connect(bell._oscillators[num].harmonicity);
        });

          // pitchEnvelope.connect(bell.frequency);

        // pitchEnvelope.connect(bell._filterFreqScaler.min);

        // pitchEnvelope.connect(bell._oscillators[0].harmonicity);

        // const bellPart = new Tone.Sequence(
        //   (time, freq) => {
        //     bell.triggerAttack(freq, time, Math.random() * 0.5 + 0.5);
        //     pitchEnvelope.triggerAttackRelease("8n", time);
        //   },
        //   [
        //     [300, null, 200],
        //     [null, 200, 200],
        //     [null, 200, null],
        //     [200, null, 200],
        //   ],
        //   "4n"
        // ).start(0);

        const conga = new Tone.MembraneSynth({
          pitchDecay: 0.508,
          octaves: 4,
          envelope: {
            attack: 0.001,
            decay: 0.3,
            sustain: 0,
            release: 0.4,
          },
        }).toDestination();

        const noiseSynth = new Tone.NoiseSynth({
          envelope: {
            attack: 0.0001,
            decay: 0.3,
            sustain: 0,
            release: 0.2,
          },
          volume: -18,
        }).toDestination();

        const congaPart = new Tone.Sequence(
          (time, pitch) => {
            bell.triggerAttack(pitch, time, Math.random() * 0.5 + 0.5);
            conga.triggerAttack(pitch, time, Math.random() * 0.5 + 0.5);
            noiseSynth.triggerAttackRelease(time);
            // pitchEnvelope.triggerAttackRelease("8n", time);
          },
          ["G4", "C5", "C5", "C5"],
          "4n"
        ).start(0);

        Tone.Transport.bpm.value = 115;

        Tone.Transport.start();

        document.getElementById("play-stop").addEventListener("click", () => {
          if (playing) {
            Tone.Transport.stop();
            playing = false;
          } else {
            Tone.Transport.start();
            playing = true;
          }
        });
      };

      StartAudioContext(Tone.context).then(play);
    </script>
  </body>
</html>
